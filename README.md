### 使用nonebot2和qq客户端来为esp32远程开关实现内网穿透

<a href="https://www.oscs1024.com/project/oscs/ppxxxg22/ESP32_WITH_NONEBOT2?ref=badge_small" alt="OSCS Status"><img src="https://www.oscs1024.com/platform/badge/ppxxxg22/ESP32_WITH_NONEBOT2.svg?size=small"/></a>

---

> #### 简介：
> 
> esp32本身可以很方便地连接到局域网中并作为服务器，通过在局域网内使用http协议来对其远程下达控制指令。
> 
> 通过使用nonebot2来作为内网穿透的工具，可以实现在qq上发送命令来在外网控制位于内网的esp32。
> 
> 也就是相当于白嫖腾讯服务器来进行内网穿透。
> 
> 缺点是需要在内网部署运行nonebot，因此需要一台服务器，树莓派或者便宜一点的香橙派都可以。
>
> [B站演示视频](https://www.bilibili.com/video/BV1gr4y1V7y8/)
---

> #### 文件说明：
> 
> `esp32_arduino`内是用于esp32单片机烧录的源程序，需要是用arduino进行烧写。
> 
> `nonebot2_plugin`是nonebot2插件，直接拖入到`{bot目录}/{bot名}/plugins/`内即可使用。

---

> #### 使用说明：
> + 先根据 _单片机程序说明_  部分对[esp32.ino](esp32_arduino/esp32.ino)这个文件修改参数，然后使用`Arduino`烧录进自己的`ESP32系列`单片机中。
> 
> + 可以先参考`nonebot2`的[文档](https://v2.nonebot.dev/docs/)或[视频](https://www.bilibili.com/video/BV1aZ4y1f7e2?vd_source=0d656b14ae90f1922a53cbbeeb23cc68)来自行部署`nonebot2`。
> 
> + (后面我也会尝试出一个针对这个项目从头开始部署的视频)
> 
> + 部署好`nonebot2`后，将[esp.py](nonebot2_plugin/esp.py)拖入到`/{你的bot名字}/plugins/`中即可。

---

> #### 单片机程序说明
> 
> 可以选用任何型号的esp32，但是由于我手上只有esp32c3安信可模组，所以引脚在此款模组下能正常工作，其他型号需要更改LED指示灯的对应引脚（具体查阅原理图或自行焊接），否则可能不会出现以下描述的现象（主要是LED指示灯）。
> 
> > ##### 引脚说明
> >
> > `IO3` -> 红色LED，指示WIFI连接情况：未连接时常亮，正常连接时熄灭。
> >
> > `IO4` -> 绿色LED，指示指令接受情况：当出现`开`或`关`的指令时亮，否则灭。
> >
> > `IO6` -> PWM信号，连接舵机信号线。
>
> > ##### 其他配置
> >
> > `ssid` - [_必填_]  wifi名
> >
> > `password` - [_必填_]  wifi密码
> >
> > `local_IP` - [_重要_] 网关IP，即路由器IP，不过一般不会变。
> >
> > `subnet` - [_一般_] 子网掩码，可以不变。
> >
> > __<u>其余参数可以默认</u>__
>
> 
> > ##### 状态说明：
> >
> > + 当配置好必填参数烧录后上电后，单片机亮红灯，表示正在连接wifi，连接完毕后红灯熄灭。
> >
> > + 当接收到动作指令时，单片机亮绿灯，表示正在执行动作，执行完毕后绿灯熄灭。

---
> #### bot命令如下：
> > ##### 帮助命令：
> >
> > `/esp32` 或 `/esp32 help`。
>
> > ##### 查看已有开关命令：
> >
> > `/esp32 ls`。
>
> > ##### 添加开关命令：
> >
> > `/esp32 add {开关名称} {开关地址}`。
> >
> > 其中，开关地址可以是`192.168.1.1`这种不带`http://`开头的地址，也可以是`http://192.168.1.1`这种带`http://`的地址，但不能是类似`http:192.168.1.1`这种写了，但又没完全写的地址。
>
> > ##### 删除开关命令：
> >
> > `/esp32 del {开关别名}`。
>
> > ##### 打开开关命令：
> >
> > `/esp32 on {开关别名}`。
>
> > ##### 关闭开关命令：
> >
> > `/esp32 off {开关别名}`。
>
> > ##### 自动变换开关：
> >
> > `/esp32 {开关名称}`。
> >
> > 本条命令会自动获取开关的当前状态并切换至下一状态。如当前开关为打开状态，则会自动切换至关闭状态，反之亦然。
>
> > ##### 更改开关别名：
> >
> > `/esp32 rename {开关原名} {开关新名}`。
>
> > ##### 更改开关地址。
> >
> > `/esp32 reurl {原地址} {新地址}`
> >
> > 其中新地址的填写要求同`/esp32 add`中的地址要求。
>
> > ##### 更改配置信息（均为全局配置属性，一般情况下没什么用）：
> >
> > `/esp32 conf {配置名称} {参数}`
> >
> > > ##### 可选的配置名称：
> > >
> > > + `on` -> 当发送`/esp32 on {开关名}`时，主机会访问`http://{开关地址}/on`这个路径，修改`on`这个键的值就是修改打开开关时访问路径。
> > >
> > > + `off` -> 同上。
> > >
> > > + `conf` -> 与上面两个类似，这是获取开关当前状态的链接子路径。
> > >
> > > + `timeout` -> 这个是访问链接的`timeout`的值。
> > >
> > > > ##### 举例：
> > > >
> > > > `/esp32 conf on myon` 这条命令会将访问`http://{开关地址}/on`变为访问`http://{开关地址}/myon`。

---

> #### 待补充的内容
>
> - [ ] 制作一个完整的教程视频
> - [ ] 使用`aiohttp`重写发起请求部分